<Window xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="using:LibreSolvE.GUI.ViewModels"
    xmlns:views="clr-namespace:LibreSolvE.GUI.Views"
    xmlns:local="using:LibreSolvE.GUI"
    xmlns:sp="clr-namespace:ScottPlot.Avalonia;assembly=ScottPlot.Avalonia"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" mc:Ignorable="d"
    d:DesignWidth="1024" d:DesignHeight="768" x:Class="LibreSolvE.GUI.Views.MainWindow"
    x:DataType="vm:MainWindowViewModel" Icon="/Assets/avalonia-logo.ico" Title="LibreSolvE">
    <Window.Resources>
        <local:EmptyStringToGrayConverter x:Key="EmptyStringToGrayConverter" />
    </Window.Resources>

    <Design.DataContext>
        <!-- This DataContext is only used for Design Time -->
        <vm:MainWindowViewModel />
    </Design.DataContext>

    <DockPanel>
        <!-- Menu -->
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="_Open..." Command="{Binding OpenCommand}" />
                <MenuItem Header="_Save" Command="{Binding SaveCommand}" />
                <MenuItem Header="_Save As..." Command="{Binding SaveAsCommand}" />
                <Separator />
                <MenuItem Header="_Exit" Command="{Binding ExitCommand}" />
            </MenuItem>
            <MenuItem Header="_Run">
                <MenuItem Header="_Execute" Command="{Binding RunCommand}" />
            </MenuItem>
        </Menu>

        <!-- Status Bar -->
        <Border DockPanel.Dock="Bottom" Background="#EEE" Padding="5">
            <TextBlock Text="{Binding StatusText}" VerticalAlignment="Center" />
        </Border>

        <!-- Toolbar (Placeholder) -->
        <Border DockPanel.Dock="Top" Background="#DDD" Padding="5" MinHeight="30">
            <TextBlock Text="Toolbar Placeholder" VerticalAlignment="Center" />
        </Border>

        <!-- Main Content Area -->
        <!-- Using a Grid to simulate EES layout: Equations on left, Results/Plots on right -->
        <Grid> <!-- This is the Grid starting around line 51 -->
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MinWidth="300" /> <!-- Equations -->
                <ColumnDefinition Width="Auto" /> <!-- GridSplitter -->
                <ColumnDefinition Width="2*" MinWidth="400" /> <!-- Results and Plots -->
            </Grid.ColumnDefinitions>

            <!-- Equations Panel -->
            <DockPanel Grid.Column="0">
                <TextBlock DockPanel.Dock="Top" Text="Equations" Margin="5" FontWeight="Bold" />
                <TextBox Text="{Binding EquationsVM.EquationText}"
                    AcceptsReturn="True"
                    TextWrapping="NoWrap"
                    ScrollViewer.HorizontalScrollBarVisibility="Auto"
                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                    FontFamily="Consolas,Monospace"
                    Margin="5" />
            </DockPanel>

            <GridSplitter Grid.Column="1" Width="5" Background="LightGray"
                HorizontalAlignment="Stretch" VerticalAlignment="Stretch" />

            <!-- Right Panel: Results and Plots (Tabbed or Stacked) -->
            <TabControl Grid.Column="2" Margin="5" SelectionChanged="TabControl_SelectionChanged">

                <TabItem Header="Solution">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top"
                            Text="{Binding SolutionVM.Variables.Count, StringFormat='Variables found: {0}'}"
                            Margin="5"
                            FontWeight="Bold" />

                        <!-- Headers for the columns -->
                        <Grid DockPanel.Dock="Top" Margin="5,10,5,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="Name" FontWeight="Bold" />
                            <TextBlock Grid.Column="1" Text="Value" FontWeight="Bold" />
                            <TextBlock Grid.Column="2" Text="Units" FontWeight="Bold" />
                            <TextBlock Grid.Column="3" Text="Source" FontWeight="Bold" />
                        </Grid>
                        <Rectangle DockPanel.Dock="Top" Height="1" Fill="Gray" Margin="5,2,5,5" />

                        <!-- Warning message -->
                        <TextBlock DockPanel.Dock="Bottom"
                            Text="If you're seeing this but no data in the grid, there may be a display issue"
                            Margin="5"
                            Foreground="Red"
                            IsVisible="{Binding !SolutionVM.Variables.Count}" />

                        <!-- Solution data -->
                        <ScrollViewer>
                            <ItemsControl ItemsSource="{Binding SolutionVM.Variables}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{Binding Name}"
                                                Margin="5,0" />
                                            <TextBlock Grid.Column="1"
                                                Text="{Binding Value, StringFormat=F6}" Margin="5,0" />
                                            <TextBlock Grid.Column="2" Text="{Binding Units}"
                                                Foreground="{Binding Units, Converter={StaticResource EmptyStringToGrayConverter}}"
                                                Margin="5,0" />
                                            <TextBlock Grid.Column="3" Text="{Binding Source}"
                                                Margin="5,0" />
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </DockPanel>
                </TabItem>

                <TabItem Header="Plots">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top"
                            Text="{Binding PlotViewModels.Count, StringFormat='Plots found: {0}'}"
                            Margin="5"
                            FontWeight="Bold" />

                        <TextBlock DockPanel.Dock="Bottom"
                            Text="No plots available. Run a file with PLOT commands."
                            Margin="5"
                            IsVisible="{Binding !PlotViewModels.Count}" />

                        <!-- Display plots using ItemsControl with our wrapper -->
                        <ItemsControl ItemsSource="{Binding PlotViewModels}" Margin="5">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:ScottPlotViewModel">
                                    <!-- Use our new ScottPlotView wrapper -->
                                    <views:ScottPlotView PlotSource="{Binding Plot}" Height="450"
                                        Margin="0,5" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                    </DockPanel>
                </TabItem>

                <TabItem Header="Raw Output">
                    <TextBox Text="{Binding OutputText}" IsReadOnly="True" Margin="5"
                        AcceptsReturn="True" TextWrapping="Wrap"
                        ScrollViewer.VerticalScrollBarVisibility="Auto"
                        FontFamily="Consolas,Monospace" />
                </TabItem>

                <TabItem Header="Integral Table">
                    <!-- Place IntegralTableView DIRECTLY as content -->
                    <!-- ADD Height and VerticalAlignment -->
                    <views:IntegralTableView
                        DataContext="{Binding IntegralTableVM}"
                        Margin="5"
                        VerticalAlignment="Stretch"
                        Height="600" /> <!-- Or another reasonable fixed height -->
                </TabItem>

                <TabItem Header="Debug Log">
                    <DockPanel>
                        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="8"
                            Margin="5">
                            <Button Content="Copy All to Clipboard"
                                Command="{Binding DebugLogVM.CopyToClipboardCommand}" />
                            <Button Content="Export to File..."
                                Command="{Binding DebugLogVM.ExportToFileCommand}" />
                            <Button Content="Clear Log"
                                Command="{Binding DebugLogVM.ClearLogCommand}" />
                        </StackPanel>
                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                            HorizontalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding DebugLogVM.Logs}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding}" TextWrapping="Wrap" Margin="2" />
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </DockPanel>
                </TabItem>

            </TabControl> <!--
            This closes the TabControl -->

        </Grid> <!--
        This closes the main content Grid -->

    </DockPanel> <!--
    This closes the root DockPanel -->

</Window> <!--
This closes the Window -->
